<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>모집글 상세 보기 - VolleyLink</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- 상단 바 -->
  <header class="top-bar">
    <div class="top-bar__left">
      <a href="index.html" class="logo">VolleyLink</a>
      <span class="logo-sub">상세 정보</span>
    </div>
  </header>

  <main class="page" id="detailContainer">
    <p>불러오는 중...</p>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /* -------------------------
       Firebase 초기화
    -------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC68iamTPIk6-0xHIEPJQMlzJoZCw6y9mg",
      authDomain: "volleylink-7165f.firebaseapp.com",
      projectId: "volleylink-7165f",
      storageBucket: "volleylink-7165f.firebasestorage.app",
      messagingSenderId: "891161836412",
      appId: "1:891161836412:web:1696fc610cdf00a42442f9",
      measurementId: "G-1CM3ZMSMTE"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* -------------------------
       URL 파라미터 (문서 ID)
    -------------------------- */
    const params = new URLSearchParams(location.search);
    const matchId = params.get("id");

    const detail = document.getElementById("detailContainer");
    let currentUser = null;

    /* -------------------------
       로그인 감지 후 로딩 시작
    -------------------------- */
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      loadDetail();
    });

    /* -------------------------
       데이터 불러오기
    -------------------------- */
    function loadDetail() {
      if (!matchId) {
        detail.innerHTML = "<p>잘못된 접근입니다.</p>";
        return;
      }

      db.collection("matches").doc(matchId).get().then((doc) => {
        if (!doc.exists) {
          detail.innerHTML = "<p>존재하지 않는 모집글입니다.</p>";
          return;
        }

        const d = doc.data();
        const isOwner = currentUser && d.createdByUid === currentUser.uid;

        detail.innerHTML = `
          <section class="card">
            <h2 class="section-title">${d.title}</h2>
            <p class="subtitle">${d.postType || "교류전"}</p>

            <div class="section-spacing">
              <p><strong>일시:</strong> ${d.dateText || "-"}</p>
              <p><strong>장소:</strong> ${d.location || "-"}</p>
              <p><strong>실력/목적:</strong> ${d.level || "-"}</p>
            </div>

            <div class="section-spacing">
              <p><strong>상세 설명</strong></p>
              <p style="white-space:pre-line; margin-top:6px;">${d.note || "-"}</p>
            </div>

            <div class="divider"></div>

            <div style="display:flex; gap:10px; margin-top:14px;">
              <button class="btn btn-primary" id="applyBtn">매칭 지원하기</button>

              ${isOwner ? `
                <button class="btn btn-secondary" id="editBtn">수정하기</button>
                <button class="btn btn-outline" id="deleteBtn">삭제하기</button>
              ` : ""}
            </div>
          </section>
        `;

        /* -------------------------
            버튼 기능 연결
        -------------------------- */
        document.getElementById("applyBtn").onclick = () =>
          handleApply(d, matchId);

        if (isOwner) {
          document.getElementById("editBtn").onclick = () =>
            location.href = "match-edit.html?id=" + matchId;

          document.getElementById("deleteBtn").onclick = () =>
            handleDelete(matchId);
        }
      });
    }

    /* -------------------------
       매칭 지원 기능
    -------------------------- */
    function handleApply(data, id) {
      if (!currentUser) {
        alert("로그인이 필요합니다.");
        return;
      }

      db.collection("matches")
        .doc(id)
        .collection("applications")
        .add({
          uid: currentUser.uid,
          email: currentUser.email,
          appliedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => alert("지원이 완료되었습니다!"));
    }

    /* -------------------------
       삭제 기능
    -------------------------- */
    function handleDelete(id) {
      if (!confirm("정말 삭제하시겠습니까?")) return;

      db.collection("matches")
        .doc(id)
        .delete()
        .then(() => {
          alert("삭제되었습니다.");
          location.href = "index.html";
        });
    }
  </script>
</body>
</html>
